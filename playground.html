<html>
<head>
<script type="module">
    import  { SlashDBClient } from './modules/slashdbclient.js';
    import { DataDiscoveryResource, DataDiscoveryDatabase } from './modules/datadiscovery.js';
    import { SQLPassThruQuery, SQLPassThruQueryList } from './modules/sqlpassthru.js';
    import { DataDiscoveryFilter } from './modules/datadiscoveryfilter.js';
    import {fetchWrapper } from './modules/fetchwrapper.js'
    import { eq, any, between, gte, lte, not, and } from './modules/filterfunctions.js';
    import { SQLPassThruFilter } from './modules/sqlpassthrufilter.js';
    import { asc, desc } from './modules/basefilter.js';


    // make methods, modules, available to console for debugging
    window.DataDiscoveryFilter = DataDiscoveryFilter
    window.eq = eq
    window.any = any
    window.gte = gte
    window.lte = lte
    window.not = not
    window.and = and
    window.desc = desc
    window.asc = asc


    window.SlashDBClient = SlashDBClient
    window.DataDiscoveryResource = DataDiscoveryResource
    window.DataDiscoveryDatabase = DataDiscoveryDatabase
    window.fetchWrapper = fetchWrapper
    window.SQLPassThruFilter = SQLPassThruFilter
    window.SQLPassThruQueryList = SQLPassThruQueryList
    window.SQLPassThruQuery = SQLPassThruQuery

    let sqf1 = new SQLPassThruQuery('myquery');
    console.log(sqf1); 
    let q2 = new DataDiscoveryFilter(eq("Country","Canada")).addFilter(and(eq("ZIP","78501"),any("Name","A","B","C"))).join("Invoice").addFilter(eq("Country","USA")).addFilter(eq("State","Texas"))
    console.log(q2)


    //create an SDB client and login
    const sdb1 = new SlashDBClient('http://192.168.1.101:8000', 'admin', 'gez0bk949rhwpcjdxqqsn8w9g4iec709');
    const sdb2 = new SlashDBClient('http://192.168.1.20:9999', 'admin', 'gez0bk949rhwpcjdxqqsn8w9g4iec709');
    
    let sql = new SQLPassThruQueryList(sdb1);
    let s = await sql.getQueryList();
    console.log(s)
    let sqh = new SQLPassThruQuery('myquery', sdb1 );
    console.log(sqh);

    sdb1.login();
    console.log('Logged in status:', await sdb1.isAuthenticated())
    
    // get some config info etc from the connected host
    console.log('---------------------------------------------------------------------------------\n')
    console.log('** Config')
    console.log('Settings --');
    console.log(await sdb1.getSettings());
    console.log('Version --');
    console.log(await sdb1.getVersion());
    console.log('Unload model taskdatadb --');
    console.log(await sdb1.unloadModel('taskdatadb'));
    console.log('Load model taskdatadb --');
    console.log(await sdb1.loadModel('taskdatadb'));
    console.log('User details for user taskapp -- ')
    console.log(await sdb1.getUser('taskapp'));
    console.log('Reflect Status for Chinook --');
    console.log(await sdb1.getReflectStatus('Chinook'));
    console.log('DB definition for Chinook --');
    console.log(await sdb1.getDbDef('Chinook'));
    console.log('Query definitions all --');
    console.log(await sdb1.getQueryDef());
    console.log('Query definition for add-new-customer --');
    console.log(await sdb1.getQueryDef('add-new-customer'));
    console.log('Queries packaged up -- ')
    console.log(await sdb1.getQueries());
    console.log('---------------------------------------------------------------------------------\n')

    let q1 = new DataDiscoveryFilter().addFilter(any('FirstName','J*,H*')).addFilter(eq('Country','USA')).sort('LastName',desc('FirstName'))
        .cols('FirstName','LastName','Company')
    console.log(q1)



    // create a data discovery object and run a query
    console.log('** Data discovery');

    console.log('option1 -- sending CSV')
    let dbs = await sdb1.getDatabases()
    console.log(dbs);
    let chinookdb = dbs['Chinook']
    let chinook_res = await chinookdb.getDataDiscoveryResources();
    console.log(chinook_res);
    let cust_res = chinook_res['Customer']
    console.log(cust_res)
    let r = await cust_res.accept('csv').get(eq("FirstName","J*"))
    console.log(r.data)
    r = await cust_res.get(q1)
    console.log(r.data)
    q1.cols(false)
    r = await cust_res.get(q1)
    console.log(r.data)
    
    console.log('\noption2 -- sending JSON')
    chinookdb = new DataDiscoveryDatabase(sdb1, 'Chinook')
    cust_res = new DataDiscoveryResource(chinookdb,'Customer');
    r = await cust_res.get(eq("FirstName","F*"))
    console.log(r.data)    
    r = await cust_res.get(q1)
    console.log(r.data)


    let mt = chinook_res['MediaType']

    // delete tests
    try {
        r = await mt.delete(gte("MediaTypeId",6))
        console.log('deleted: ', r.status)
    }
    catch(e) {
        console.log(e)
    }

    // post tests
    for (let i = 6; i <= 10; i++) {
        r = await mt.post({"Name":`media type ${i} again`})
        console.log( 'created: ', r.status, r.url)
    }

    
    // put tests
    mt.contentType('json');
    let q = new DataDiscoveryFilter(eq("MediaTypeId",8))
    try {
        //mt.sdbClient.host = "http://noname";
        //mt.dbPrefix = "/missingPfx";
        r = await mt.put(q, {"Name":"changing id 8 TESTNEW"})
        console.log( 'updated: ', r.status, r.url);
    }
    catch(e) {
        console.log('in catch:', e.name, e.message)
    }
    q = new DataDiscoveryFilter().addFilter(eq("MediaTypeId",9))
    r = await mt.put(q, {"Name":"change id 9 TESTNEW"})
    // put follows to last context test
    // q = new DataDiscoveryFilter(eq("MediaTypeId",1)).join("Track").addFilter(eq("TrackId",1))
    // console.log(q)
    // r = await mt.put(q, {"Name":"For Those About To Rock (We Salute You) - TEST"})


    // changing content-types
    r = await mt.contentType('csv').put(eq("Name","MPEG audio file"), 'Name\ncsvnamechange' )
    r = await mt.contentType('json').put(eq("Name","csvnamechange"), {Name:"jObjnamechange"})
    r = await mt.put(eq("Name","jObjnamechange"), {"Name":"jsonnamechange",})
    r = await mt.contentType('xml').put(eq("Name","jsonnamechange"), '<SlashDB xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://www.vtenterprise.com/slashdb"><MediaType><Name>xmlNamechange</Name></MediaType></SlashDB>')
    r = await mt.contentType('json').put(eq("Name","xmlNamechange"), {"Name":"MPEG audio file"})



</script>

</head>
<body>
hello world
</body>
</html>