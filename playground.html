<html>
<head>
    <style>
        .codeBlock { 
            margin: 25px 15px; 
            padding: 20px; 
            font-family: sans-serif; 
            background: #EEE; 
            box-shadow: 0 0 10px #000;
            border-radius: 10px;
        }
        .outTxt { width: 80%; padding: 10px;}
    </style>
<script type="module">
    import { SlashDBClient } from './modules/slashdbclient.js';
    import { DataDiscoveryResource, DataDiscoveryDatabase } from './modules/datadiscovery.js';
    import { SQLPassThruQuery } from './modules/sqlpassthru.js';
    import { DataDiscoveryFilter } from './modules/datadiscoveryfilter.js';
    import { SQLPassThruFilter } from './modules/sqlpassthrufilter.js';
    import { eq, any, between, gte, lte, not, and } from './modules/filterfunctions.js';
    import { asc, desc } from './modules/basefilter.js';


    // make methods, modules, available to console for debugging
    window.DataDiscoveryFilter = DataDiscoveryFilter
    window.SlashDBClient = SlashDBClient
    window.DataDiscoveryResource = DataDiscoveryResource
    window.DataDiscoveryDatabase = DataDiscoveryDatabase
    window.SQLPassThruFilter = SQLPassThruFilter
    window.SQLPassThruQuery = SQLPassThruQuery
    window.eq = eq
    window.any = any
    window.gte = gte
    window.lte = lte
    window.not = not
    window.and = and
    window.desc = desc
    window.asc = asc

    var host;
    var user;
    var password;
    var apiKey;
    var database;
    var query;

    export function exec() {
        host = document.forms.config.host.value;
        user = document.forms.config.user.value;
        password = document.forms.config.password.value;
        apiKey = document.forms.config.apiKey.value;
        database = document.forms.config.database.value;
        query = document.forms.config.query.value;
        sdbLoginDemo();
        sdbAPIDemo();        
    }

    window.exec = exec;

    const sdbLoginDemo = async () => {
        let outTxt = '';
        const sdbClient = new SlashDBClient('http://192.168.1.101:8000');

        outTxt += `* SlashDBClient() - Client created, logging in user ${user}...\n`
        document.querySelector('#clientTxt').innerHTML = outTxt;
        let status = await sdbClient.login(user,password);
        outTxt += `* login() - Logged in status: ${status}`;
        document.querySelector('#clientTxt').innerHTML = outTxt;
    }
     

    const sdbAPIDemo = async () => {
        let outTxt = '';
        const sdbClient = new SlashDBClient(host,user,apiKey);
        outTxt += `* SlashDBClient() - Client created, logging in user ${user} using API key...\n`
        document.querySelector('#apiTxt').innerHTML = outTxt;
        let status = await sdbClient.isAuthenticated();
        outTxt += `* isAuthenticated() - Logged in status: ${status}\n`;
        document.querySelector('#apiTxt').innerHTML = outTxt;
        let version = await sdbClient.getVersion();      
        outTxt += `* getVersion() - SlashDB version: ${version}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt;        
        let settings = JSON.stringify(await sdbClient.getSettings()).substr(0,80) + '...';
        outTxt += `* getSettings() - SlashDB settings: ${settings}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt;        
        let userDetails = JSON.stringify(await sdbClient.getUser(user)).substr(0,80) + '...';
        outTxt += `* getUser() - User details: ${userDetails}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt;        
        let dbDef = JSON.stringify(await sdbClient.getDbDef(database)).substr(0,80) + '...';
        outTxt += `* getDbDef() - ${database} database definition: ${dbDef}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt;  
        let dbReflect = JSON.stringify(await sdbClient.getReflectStatus(database)).substr(0,80) + '...';
        outTxt += `* getReflectStatus() - ${database} database reflect status: ${dbReflect}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt;    
        let queryDef = JSON.stringify(await sdbClient.getQueryDef(query)).substr(0,80) + '...';
        outTxt += `* getQueryDef() - ${query} query definition: ${queryDef}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt;     
        let sqlPassThruObj = JSON.stringify(await sdbClient.getQueries(database)).substr(0,80) + '...';
        outTxt += `* getQueries() - ${database} DB queries as SQLPassThru objects: ${sqlPassThruObj}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt; 
        let unloadDb = JSON.stringify(await sdbClient.unloadModel(database)).substr(0,80) + '...';
        outTxt += `* unloadModel() - Disconnect ${database} database: ${unloadDb}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt;          
        let loadDb = JSON.stringify(await sdbClient.loadModel(database)).substr(0,80) + '...';
        outTxt += `* loadModel() - Connect ${database} database: ${loadDb}\n`;        
        document.querySelector('#apiTxt').innerHTML = outTxt;           
        
    }
       


    // let sqf1 = new SQLPassThruQuery('myquery');
    // console.log(sqf1); 
    // let q2 = new DataDiscoveryFilter(eq("Country","Canada")).addFilter(and(eq("ZIP","78501"),any("Name","A","B","C"))).join("Invoice").addFilter(eq("Country","USA")).addFilter(eq("State","Texas"))
    // console.log(q2)
    
    const sdb1 = new SlashDBClient(host, user, apiKey);
    console.log('SlashDBClient sdb1 logged in status:', await sdb1.isAuthenticated())
    
    // get some config info etc from the connected host
    console.log('---------------------------------------------------------------------------------\n')
    console.log('** Config')
    console.log('Settings --');
    console.log(await sdb1.getSettings());
    console.log('Version --');
    console.log(await sdb1.getVersion());
    console.log('Unload model taskdatadb --');
    console.log(await sdb1.unloadModel('taskdatadb'));
    console.log('Load model taskdatadb --');
    console.log(await sdb1.loadModel('taskdatadb'));
    console.log('User details for user taskapp -- ')
    console.log(await sdb1.getUser('taskapp'));
    console.log('Reflect Status for Chinook --');
    console.log(await sdb1.getReflectStatus('Chinook'));
    console.log('DB definition for Chinook --');
    console.log(await sdb1.getDbDef('Chinook'));
    console.log('Query definitions all --');
    console.log(await sdb1.getQueryDef());
    console.log('Query definition for add-new-customer --');
    console.log(await sdb1.getQueryDef('add-new-customer'));
    console.log('Queries packaged up -- ')
    console.log(await sdb1.getQueries());
    console.log('---------------------------------------------------------------------------------\n')

    // let q1 = new DataDiscoveryFilter().addFilter(any('FirstName','J*,H*')).addFilter(eq('Country','USA')).sort('LastName',desc('FirstName'))
    //     .cols('FirstName','LastName','Company')
    // console.log(q1)



    // // create a data discovery object and run a query
    // console.log('** Data discovery');

    // console.log('option1 -- sending CSV')
    // let dbs = await sdb1.getDatabases()
    // console.log(dbs);
    // let chinookdb = dbs['Chinook']
    // let chinook_res = await chinookdb.getDataDiscoveryResources();
    // console.log(chinook_res);
    // let cust_res = chinook_res['Customer']
    // console.log(cust_res)
    // let r = await cust_res.accept('csv').get(eq("FirstName","J*"))
    // console.log(r.data)
    // r = await cust_res.get(q1)
    // console.log(r.data)
    // q1.cols(false)
    // r = await cust_res.get(q1)
    // console.log(r.data)
    
    // console.log('\noption2 -- sending JSON')
    // chinookdb = new DataDiscoveryDatabase(sdb1, 'Chinook')
    // cust_res = new DataDiscoveryResource(chinookdb,'Customer');
    // r = await cust_res.get(eq("FirstName","F*"))
    // console.log(r.data)    
    // r = await cust_res.get(q1)
    // console.log(r.data)


    // let mt = chinook_res['MediaType']

    // // delete tests
    // try {
    //     r = await mt.delete(gte("MediaTypeId",6))
    //     console.log('deleted: ', r.status)
    // }
    // catch(e) {
    //     console.log(e)
    // }

    // // post tests
    // for (let i = 6; i <= 10; i++) {
    //     r = await mt.post({"Name":`media type ${i} again`})
    //     console.log( 'created: ', r.status, r.url)
    // }

    
    // // put tests
    // mt.contentType('json');
    // let q = new DataDiscoveryFilter(eq("MediaTypeId",8))
    // try {
    //     //mt.sdbClient.host = "http://noname";
    //     //mt.dbPrefix = "/missingPfx";
    //     r = await mt.put(q, {"Name":"changing id 8 TESTNEW"})
    //     console.log( 'updated: ', r.status, r.url);
    // }
    // catch(e) {
    //     console.log('in catch:', e.name, e.message)
    // }
    // q = new DataDiscoveryFilter().addFilter(eq("MediaTypeId",9))
    // r = await mt.put(q, {"Name":"change id 9 TESTNEW"})
    // // put follows to last context test
    // // q = new DataDiscoveryFilter(eq("MediaTypeId",1)).join("Track").addFilter(eq("TrackId",1))
    // // console.log(q)
    // // r = await mt.put(q, {"Name":"For Those About To Rock (We Salute You) - TEST"})


    // // changing content-types
    // r = await mt.contentType('csv').put(eq("Name","MPEG audio file"), 'Name\ncsvnamechange' )
    // r = await mt.contentType('json').put(eq("Name","csvnamechange"), {Name:"jObjnamechange"})
    // r = await mt.put(eq("Name","jObjnamechange"), {"Name":"jsonnamechange",})
    // r = await mt.contentType('xml').put(eq("Name","jsonnamechange"), '<SlashDB xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://www.vtenterprise.com/slashdb"><MediaType><Name>xmlNamechange</Name></MediaType></SlashDB>')
    // r = await mt.contentType('json').put(eq("Name","xmlNamechange"), {"Name":"MPEG audio file"})



</script>

</head>
<body>

    <script>

    </script>

    <div id="clientDesc" class="codeBlock">
        Connection Config
        <form onsubmit="return false" name="config">
            <label>Host</label>
            <input name="host" type="text" value="http://192.168.1.101:8000">
            <label>Username</label>
            <input name="user" type="text" value="admin">
            <label>Password</label>
            <input name="password" type="password" value="">
            <label>API Key</label>
            <input name="apiKey" type="password" value="">
            <label>Database</label>
            <input name="database" type="text" value="Chinook">            
            <label>Query</label>
            <input name="query" type="text" value="add-new-customer">            

            <button onClick="exec()">Run demo</button>
        </form>
    </div>


    <div id="clientDesc" class="codeBlock">
        Create a SlashDBClient object and log in to SlashDB with username/password
        <pre>
        const sdbClient = new SlashDBClient('http://hostname:port');
        let status = await sdbClient.login(username,password);
        </pre>
        <textarea id="clientTxt" class="outTxt">Click Run Demo button...</textarea>
    </div>

    <div id="apiDesc" class="codeBlock">
        SlashDBClient API method list
        <pre>
        const sdbClient = new SlashDBClient('http://hostname:port', user, apiKey);
        let status = await sdbClient.isAuthenticated();
        let version = await sdbClient.getVersion();     
        let settings = await sdbClient.getSettings();      
        let userDetails = await sdbClient.getUser(user);                        // leave user empty for all users
        let dbDefinition = await sdbClient.getDbDef(database);                  // leave parameter empty for all databases
        let dbReflectStatus = await sdbClient.getDbReflectStatus(database);     // leave parameter empty for all databases
        let queryDef = await sdbClient.getQueryDef(query);                      // leave parameter empty for all queries
        let sqlPassThruObjects = sdbClient.getQueries(database);                // leave parameter empty for queries in all databases
        let unloadDB = sdbClient.unloadModel(database);
        let loadDB = sdbClient.loadModel(database);        
        </pre>
        <textarea id="apiTxt" style="height: 14rem" class="outTxt">Click Run Demo button...</textarea>
     
    </div>    
</body>
</html>